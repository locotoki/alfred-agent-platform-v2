name: Test Alert Explainer

on:
  pull_request:
    paths:
      - 'alfred/alerts/explainer/**'
      - 'alfred/slack/diagnostics/**'
      - 'tests/unit/alfred/alerts/explainer/**'
      - 'tests/unit/alfred/slack/diagnostics/**'
      - 'tests/integration/test_explainer_smoke.py'
      - 'charts/alfred/charts/explainer-bot/**'
      - 'docker/explainer-bot/**'

jobs:
  kind-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: helm/kind-action@v1
        with:
          cluster_name: kind-explainer-test
      
      - name: Build explainer image
        run: |
          docker build -f docker/explainer-bot/Dockerfile -t ghcr.io/alfred-platform/explainer-bot:test .
          kind load docker-image ghcr.io/alfred-platform/explainer-bot:test --name kind-explainer-test
      
      - name: Deploy Alfred with explainer
        run: |
          helm upgrade --install alfred ./charts/alfred \
            --set explainer.enabled=true \
            --set explainer.image.tag=test \
            --set explainer.image.pullPolicy=Never \
            --wait --timeout=5m
      
      - name: Run explainer smoke test
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=explainer-bot --timeout=60s
          
          # Port forward to access the service
          kubectl port-forward svc/alfred-explainer-bot 8080:8080 &
          PF_PID=$!
          sleep 5
          
          # Test the health endpoint
          curl -f http://localhost:8080/health
          
          # Test the explain endpoint with fixture  
          curl -f -X POST http://localhost:8080/explain \
            -H "Content-Type: application/json" \
            -d @tests/fixtures/alerts/alert_critical.json
          
          kill $PF_PID
      
      - name: Check logs on failure
        if: failure()
        run: |
          kubectl logs -l app.kubernetes.io/name=explainer-bot --tail=50
          kubectl describe pod -l app.kubernetes.io/name=explainer-bot