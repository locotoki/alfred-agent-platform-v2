name: compose-validate-and-up
on:
  pull_request:
    branches: [main]
    paths:
      - "docker-compose.yml"
      - ".github/workflows/ci-compose.yml"
      - "services/**"
jobs:
  compose-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx (installs Docker Compose v2)
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: ${{ runner.os }}-buildx-

      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config

      - name: Create env file
        run: |
          cat <<EOF > .env.ci
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD || 'redis-test-password' }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD || 'postgres-test-password' }}
          DB_JWT_SECRET=${{ secrets.DB_JWT_SECRET || 'test-jwt-secret' }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY || 'test-openai-key' }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN || 'test-telegram-token' }}
          SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN || 'test-slack-token' }}
          SLACK_SIGNING_SECRET=${{ secrets.SLACK_SIGNING_SECRET || 'test-slack-secret' }}
          SLACK_APP_TOKEN=${{ secrets.SLACK_APP_TOKEN || 'test-slack-app-token' }}
          EOF

      - name: Compose up (detached) with retry x3
        run: |
          set -e
          for i in 1 2 3; do
            echo "Attempt $iâ€¦"
            docker compose -f docker-compose.yml --env-file .env.ci up -d && break
            echo "Compose up failed, retrying in 10 s"
            docker compose logs
            sleep 10
          done

      - name: Basic health probe
        run: |
          sleep 15
          docker compose ps
          curl -sf http://localhost:8000/health || (echo "Health probe failed"; docker compose logs; exit 1)

      - name: Tear down stack (always)
        if: always()
        run: docker compose -f docker-compose.yml down -v