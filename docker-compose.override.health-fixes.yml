# Comprehensive health check fixes for all services
# Generated: 2025-05-27

services:
  # Fix all db-*-metrics services - use port 9103 instead of 9091
  db-admin-metrics:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  db-api-metrics:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  db-auth-metrics:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  db-realtime-metrics:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  db-storage-metrics:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Fix services missing curl - use curl when available
  slack-adapter:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  slack_mcp_gateway:
    environment:
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  # Fix slow-start services with increased timeouts
  llm-service:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  vector-db:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  crm-sync:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  # Services that need environment fixes
  db-auth:
    build:
      context: ./services/db-auth
      dockerfile: Dockerfile
    image: alfred-platform/db-auth:fixed
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      GOTRUE_DB_DATABASE_URL: postgres://postgres:postgres@db-postgres:5432/auth_db?search_path=auth
      GOTRUE_DISABLE_SIGNUP: "true"
      API_EXTERNAL_URL: http://localhost:9999
      GOTRUE_SITE_URL: http://localhost:9999
      GOTRUE_JWT_SECRET: super-secret-jwt-token-for-dev
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9999/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  db-storage:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  # Disable health checks for stub services
  model-router:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  model-registry:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  agent-rag:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  agent-atlas:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  agent-social:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  agent-bizdev:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  ui-admin:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  ui-chat:
    command: ["streamlit", "run", "streamlit_chat_ui.py", "--server.address=0.0.0.0", "--server.port=8501"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 30s

  auth-ui:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  hubspot-mock:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  mail-server:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  # Additional database services that are stubs
  db-admin:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  db-api:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  db-realtime:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  monitoring-db:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  monitoring-node:
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 10s
      retries: 1

  monitoring-redis:
    healthcheck:
      test: ["CMD", "/redis_exporter", "--help"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  redis-exporter:
    healthcheck:
      test: ["CMD", "/redis_exporter", "--help"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s
